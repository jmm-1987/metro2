{% extends 'base.html' %}
{% block title %}Inicio{% endblock %}
{% block content %}
<div class="card shadow p-4 flex-grow-1">
  <div class="d-flex justify-content-end mb-2 botones-superiores">
    <button id="toggle-resueltas" class="btn btn-outline-secondary btn-sm btn-ver-resueltas" title="Ver resueltas">
      <i class="bi bi-eye"></i> <span class="btn-text">Ver resueltas</span>
    </button>
    <a href="{{ url_for('crear_tarea') }}" class="btn btn-primary btn-sm ms-2 btn-crear-tarea" title="Crear tarea">
      <i class="bi bi-plus"></i> <span class="btn-text">Crear tarea</span>
    </a>
    {% if es_admin %}
    <select id="filtro-comercial" class="form-select form-select-sm ms-2 filtro-comercial" style="width:auto;display:inline-block;max-width:200px;">
      <option value="">Todos los comerciales</option>
      {% for usuario in usuarios %}
        <option value="{{ usuario.id }}">{{ usuario.nombre }}</option>
      {% endfor %}
    </select>
    {% endif %}
  </div>
  <div id='calendar' class="h-100"></div>
</div>

<script>
  // Variable global para saber si el usuario es admin
  window.esAdmin = {{ es_admin|tojson }};
</script>
<script>
  // Funci√≥n global para enviar encuesta
  function enviarEncuesta(telefono, clienteId) {
    console.log('Funci√≥n enviarEncuesta llamada con:', telefono, clienteId);
    
    if (!clienteId) {
      alert('No se pudo identificar el cliente para enviar la encuesta.');
      return;
    }
    
    // Limpiar y formatear el n√∫mero de tel√©fono
    let telefonoLimpio = telefono.replace(/[^\d+]/g, ''); // Solo n√∫meros y +
    
    // Si no empieza con +, agregar +34 (Espa√±a)
    if (!telefonoLimpio.startsWith('+')) {
      // Si empieza con 6 y tiene 9 d√≠gitos, es espa√±ol
      if (telefonoLimpio.startsWith('6') && telefonoLimpio.length === 9) {
        telefonoLimpio = '+34' + telefonoLimpio;
      } else if (telefonoLimpio.startsWith('34') && telefonoLimpio.length === 11) {
        telefonoLimpio = '+' + telefonoLimpio;
      } else if (telefonoLimpio.length === 9) {
        telefonoLimpio = '+34' + telefonoLimpio;
      }
    }
    
    // Verificar que el n√∫mero sea v√°lido
    if (!telefonoLimpio || telefonoLimpio.length < 10) {
      alert('N√∫mero de tel√©fono inv√°lido: ' + telefono);
      return;
    }
    
    const texto = encodeURIComponent('Hola. ' +
'Gracias por visitar el inmueble con Metro Cuadrado M√©rida. ' +
'Queremos brindarte la mejor atenci√≥n posible y por eso nos encantar√≠a saber como fue tu experiencia y como te sentiste durante la visita. ' +
'' +
'Solo tienes que contestar a una pregunta muy breve: ' +
'üëâ https://metro2-9bxg.onrender.com/formulario?cliente_id=' + clienteId + ' ' +
'' +
'¬°Vuestra opini√≥n nos ayuda a mejorar cada d√≠a! ' +
'' +
'Un saludo, el equipo de Metro Cuadrado M√©rida.');
    
    const businessUrl = `whatsapp://send?phone=${telefonoLimpio}&text=${texto}`;
    const personalUrl = `https://wa.me/${telefonoLimpio}?text=${texto}`;
    
    // Intentar abrir WhatsApp
    window.open(businessUrl, '_blank');
    setTimeout(() => {
      window.open(personalUrl, '_blank');
    }, 500);
    
    // Esperar 5 segundos y luego preguntar si se marc√≥ como enviada
    setTimeout(() => {
      console.log('Mostrando confirmaci√≥n de env√≠o de encuesta...');
      
      // Crear un modal personalizado en lugar de usar confirm()
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
      `;
      
      const modalContent = document.createElement('div');
      modalContent.style.cssText = `
        background: white;
        padding: 30px;
        border-radius: 10px;
        max-width: 400px;
        text-align: center;
        box-shadow: 0 4px 20px rgba(0,0,0,0.3);
      `;
      
      modalContent.innerHTML = `
        <h4 style="margin-bottom: 20px; color: #333;">Confirmar env√≠o de encuesta</h4>
        <p style="margin-bottom: 25px; color: #666; line-height: 1.5;">
          ¬øQuieres marcar la encuesta como enviada?<br><br>
          <strong>Si la encuesta se envi√≥ correctamente</strong>, haz clic en "S√≠".<br>
          <strong>Si hubo alg√∫n problema</strong>, haz clic en "No".
        </p>
        <div style="display: flex; gap: 10px; justify-content: center;">
          <button id="btn-confirmar-si" style="
            background: #28a745;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
          ">S√≠, marcar como enviada</button>
          <button id="btn-confirmar-no" style="
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
          ">No, hubo problemas</button>
        </div>
      `;
      
      modal.appendChild(modalContent);
      document.body.appendChild(modal);
      
      // Event listeners para los botones
      document.getElementById('btn-confirmar-si').addEventListener('click', function() {
        console.log('Usuario confirm√≥ env√≠o de encuesta');
        document.body.removeChild(modal);
        
        console.log('Marcando encuesta como enviada...');
        // Guardar en la base de datos
        fetch(`/api/marcar_encuesta_enviada/${clienteId}`, {
          method: 'POST', 
          headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'Content-Type': 'application/json'
          }
        })
        .then(response => {
          console.log('Respuesta del servidor:', response);
          return response.json();
        })
        .then(data => {
          console.log('Datos de respuesta:', data);
          if (!data.success) {
            alert('No se pudo actualizar el estado de la encuesta en la base de datos: ' + (data.error || 'Error desconocido'));
          } else {
            console.log('Encuesta marcada como enviada correctamente');
            // Refrescar el calendario para mostrar los cambios
            if (typeof calendar !== 'undefined') {
              calendar.refetchEvents();
            }
          }
        })
        .catch(error => {
          console.error('Error al marcar encuesta como enviada:', error);
          alert('Error al conectar con el servidor: ' + error.message);
        });
      });
      
      document.getElementById('btn-confirmar-no').addEventListener('click', function() {
        console.log('Usuario cancel√≥ el marcado de encuesta como enviada');
        document.body.removeChild(modal);
      });
      
    }, 5000); // 5 segundos de espera
  }

  let mostrarResueltas = false;
  let calendar;
  document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    var isMobile = window.innerWidth <= 700;
    calendar = new FullCalendar.Calendar(calendarEl, {
      locale: 'es',
      firstDay: 1,
      headerToolbar: {
        left: 'prev,next',
        center: 'title',
        right: isMobile ? 'dayGridMonth,dayGridWeek,listDay,crearTareaButton,today' : 'dayGridMonth,dayGridWeek,listDay,crearTareaButton,today'
      },
      customButtons: {
        crearTareaButton: {
          text: '+',
          click: function() {
            window.location.href = "{{ url_for('crear_tarea') }}";
          }
        }
      },
      buttonText: {
        today:    'Hoy',
        month:    'Mes',
        week:     'Semana',
        day:      'D√≠a'
      },
      views: {
        listDay: {
          type: 'list',
          duration: { days: 1 },
          buttonText: 'D√≠a',
          noEventsText: 'No hay eventos para este d√≠a.',
          listDayFormat: { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' },
          titleFormat: { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' }
        }
      },
      initialView: 'listDay',
      titleFormat: isMobile ? { day: 'numeric', month: 'long' } : { year: 'numeric', month: 'long', day: 'numeric' },
      events: function(fetchInfo, successCallback, failureCallback) {
        let url = '/api/events?start=' + fetchInfo.startStr + '&end=' + fetchInfo.endStr;
        if (mostrarResueltas) {
          url += '&mostrar_resueltas=1';
        }
        // Filtro de comercial solo para admin
        {% if es_admin %}
        const filtroComercial = document.getElementById('filtro-comercial');
        if (filtroComercial && filtroComercial.value) {
          url += '&comercial_id=' + filtroComercial.value;
        }
        {% endif %}
        fetch(url)
          .then(response => response.json())
          .then(data => successCallback(data))
          .catch(error => failureCallback(error));
      },
      height: '100%',
      eventContent: function(arg) {
        // Mostrar por consola el estado para depuraci√≥n
        if (arg.event.extendedProps && arg.event.extendedProps.estado) {
          console.log('Estado de tarea:', arg.event.extendedProps.estado, arg.event.title);
        }
        // Declarar los estados resueltos una sola vez
        const estadosResueltos = ['cancelado', 'pendiente', 'reagendada'];
        // Tooltip personalizado para mes y semana
        if (arg.view.type === 'dayGridWeek' || arg.view.type === 'dayGridMonth') {
          let hora = '';
          if (arg.event.start && (arg.event.start.getHours() + arg.event.start.getMinutes() > 0)) {
            hora = arg.event.start.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', hour12: false });
          }
          let fecha = arg.event.start ? arg.event.start.toLocaleDateString('es-ES') : '';
          let comercial = arg.event.extendedProps.comercial || '';
          let cliente = arg.event.extendedProps.cliente || '';
          let comentario = arg.event.title || '';
          let tooltip = `Hora: ${hora}\nFecha: ${fecha}\nComercial: ${comercial}\nCliente: ${cliente}\nTarea: ${comentario}`;
          let title = (hora ? hora + ' - ' : '') + comentario;
          // Detectar si la tarea est√° resuelta para tachar
          let estadoMes = (arg.event.extendedProps.estado || '').toLowerCase();
          if (estadosResueltos.includes(estadoMes)) {
            title = `<span style='text-decoration: line-through; color: #888;'>${title}</span>`;
          }
          let div = document.createElement('div');
          div.innerHTML = title;
          div.style.backgroundColor = arg.event.backgroundColor || '#fff';
          div.style.border = '1.5px solid ' + (arg.event.borderColor || '#dee2e6');
          div.style.color = '#222';
          div.style.fontSize = '0.98em';
          div.style.borderRadius = '7px';
          div.style.padding = '2px 6px';
          div.style.margin = '1px 0';
          div.style.overflow = 'hidden';
          div.style.whiteSpace = 'nowrap';
          div.style.textOverflow = 'ellipsis';
          div.style.maxWidth = '100%';
          div.title = tooltip;
          return { domNodes: [div] };
        }
        const isMobile = window.innerWidth <= 700;
        if (arg.view.type === 'listDay' && isMobile) {
          let telefono = arg.event.extendedProps.telefono || '';
          let cliente = arg.event.extendedProps.cliente || '';
          let comercialColor = arg.event.extendedProps.comercial_color || '#198754';
          let hora = arg.event.start ? arg.event.start.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', hour12: false }) : '';
          let whatsappBtn = '';
          let llamarBtn = '';
          console.log('TAREA:', cliente, 'TEL:', telefono);
          if (telefono) {
            let telClean = telefono.replace(/[^\d+]/g, '');
            whatsappBtn = `<a href='https://wa.me/${telClean}' target='_blank' title='WhatsApp' class='btn btn-outline-success btn-sm btn-whatsapp' onclick='event.stopPropagation();'><i class='bi bi-whatsapp'></i></a>`;
            llamarBtn = `<a href='tel:${telClean}' title='Llamar' class='btn btn-outline-primary btn-sm btn-llamar' onclick='event.stopPropagation();'><i class='bi bi-telephone'></i></a>`;
          }
          let comercialCircle = `<span style='display:inline-block;width:18px;height:18px;border-radius:50%;background:${comercialColor};margin-right:6px;vertical-align:middle;'></span>`;
          let urlEditar = arg.event.url || '#';
          let html = `
            <a href='${urlEditar}' class='tarea-movil-link' style='text-decoration:none;color:inherit;'>
              <div class='d-flex align-items-center w-100' style='min-height:32px;gap:6px;'>
                <span class='color-comercial-movil' style='background:${comercialColor};'></span>
                <span class='hora-movil'>${hora}</span>
                <span class='nombre-cliente-movil'>${cliente}</span>
                <span class='botones-accion-movil'>${whatsappBtn}${llamarBtn}</span>
              </div>
            </a>
          `;
          return { html: html };
        }
        if (arg.view.type === 'listDay') {
          if (arg.event.extendedProps.isHeader) {
            return {
              html: `
                <div class="d-flex align-items-start w-100 fw-bold mb-2" style="background: #f8f9fa; border-bottom: 2px solid #adb5bd; min-height: 40px;">
                  <div style="width: 140px; min-width: 140px; max-width: 140px; text-align:center; padding: 0.5rem 0.25rem; word-wrap: break-word;">Comercial</div>
                  <div style="width: 180px; min-width: 180px; max-width: 180px; text-align:center; padding: 0.5rem 0.25rem; word-wrap: break-word;">Cliente</div>
                  <div class="flex-grow-1" style="min-width: 200px; text-align:center; padding: 0.5rem 0.25rem; word-wrap: break-word;">Tarea</div>
                  <div style="width: 120px; min-width: 120px; max-width: 120px; text-align:center; padding: 0.5rem 0.25rem; word-wrap: break-word;">Acciones</div>
                  <div style="width: 120px; min-width: 120px; max-width: 120px; text-align:center; padding: 0.5rem 0.25rem; word-wrap: break-word;">Estado</div>
                </div>
              `
            };
          }
          // Colores de fondo y estado
          let bgColor = '#fff';
          let estado = arg.event.extendedProps.estado || '';
          let estadoColor = '#6c757d';
          let estadoBadge = '';
          if (estado === 'Por hacer') {
            bgColor = '#fff';
            estadoColor = '#6c757d';
            estadoBadge = `<span class='badge bg-secondary'>Por hacer</span>`;
          } else if (estado === 'Standby' || estado === 'pendiente') {
            bgColor = '#f7f7e6';
            estadoColor = '#bfa134';
            estadoBadge = `<span class='badge bg-warning text-dark'>Standby</span>`;
          } else if (estado === 'Cancelado' || estado === 'Finalizado' || estado === 'finalizado') {
            bgColor = '#f8d7da';
            estadoColor = '#dc3545';
            estadoBadge = `<span class='badge bg-danger'>Finalizado</span>`;
          } else if (estado === 'Reagendada' || estado === 'reagendada') {
            bgColor = '#fffbe6';
            estadoColor = '#bfa134';
            estadoBadge = `<span class='badge bg-warning text-dark'>Reagendada</span>`;
          }

          // WhatsApp icono y enlace
          let cliente = arg.event.extendedProps.cliente || '';
          let clienteHtml = cliente;
          let telefono = arg.event.extendedProps.telefono || '';
          let clienteId = arg.event.extendedProps.cliente_id || '';
          let encuestaEnviada = arg.event.extendedProps.encuesta_enviada || '';
          let whatsappBtn = '';
          let encuestaBtn = '';
          
          if (telefono) {
            let telClean = telefono.replace(/[^\d]/g, '');
            whatsappBtn = `<a href='https://wa.me/${telClean}' target='_blank' title='Enviar WhatsApp' class='btn btn-outline-success btn-sm whatsapp-btn' style='padding: 0.25rem 0.5rem;' onclick='event.stopPropagation(); event.preventDefault(); window.open(this.href, "_blank"); return false;'><i class='bi bi-whatsapp'></i></a>`;
            
            // Bot√≥n de encuesta - solo mostrar si no est√° respondida
            if (encuestaEnviada !== "respondida") {
              const title = encuestaEnviada === 'enviada' ? 'Volver a enviar encuesta' : 'Enviar encuesta';
              const btnClass = encuestaEnviada === 'enviada' ? 'btn-outline-warning' : 'btn-outline-info';
              const icon = encuestaEnviada === 'enviada' ? 'bi-hourglass-split' : 'bi-clipboard-check';
              encuestaBtn = `<a href="#" class="btn ${btnClass} btn-sm encuesta-btn" style="padding: 0.25rem 0.5rem;" data-telefono="${telefono}" data-cliente-id="${clienteId}" title="${title}" onclick="event.stopPropagation(); enviarEncuesta('${telefono}', '${clienteId}');"><i class="bi ${icon}"></i></a>`;
              console.log('Generando bot√≥n de encuesta para cliente:', clienteId, 'tel√©fono:', telefono, 'estado:', encuestaEnviada);
            } else {
              encuestaBtn = `<span style='width: 32px; height: 32px; display: inline-block;'></span>`;
              console.log('Encuesta ya respondida para cliente:', clienteId, 'no se muestra bot√≥n');
            }
          } else {
            whatsappBtn = `<span style='width: 32px; height: 32px; display: inline-block;'></span>`;
            encuestaBtn = `<span style='width: 32px; height: 32px; display: inline-block;'></span>`;
          }

          // Detectar si la tarea est√° resuelta para tachar
          let estadoLista = (arg.event.extendedProps.estado || '').toLowerCase();
          let tareaHtml = arg.event.title;
          if (estadosResueltos.includes(estadoLista)) {
            tareaHtml = `<span style='text-decoration: line-through; color: #888;'>${tareaHtml}</span>`;
          }

          let eventHtml = `
            <div class="d-flex align-items-start w-100" style="min-height: 40px; background:${bgColor}; border-bottom:1px solid #dee2e6;">
              <div style="width: 140px; min-width: 140px; max-width: 140px; text-align:center; padding: 0.5rem 0.25rem; word-wrap: break-word;">${arg.event.extendedProps.comercial || ''}</div>
              <div style="width: 180px; min-width: 180px; max-width: 180px; text-align:center; padding: 0.5rem 0.25rem; word-wrap: break-word;">${clienteHtml}</div>
              <div class="flex-grow-1" style="min-width: 200px; text-align:center; padding: 0.5rem 0.25rem; word-wrap: break-word;">${tareaHtml}</div>
              <div style="width: 120px; min-width: 120px; max-width: 120px; display: flex; justify-content: center; align-items: center; gap: 0.25rem; padding: 0.5rem 0.25rem;">
                <a href="${arg.event.url}" class="btn btn-outline-primary btn-sm" title="Resolver" style="padding: 0.25rem 0.5rem;">
                  <i class="bi bi-pencil-square"></i>
                </a>
                ${whatsappBtn}
                ${encuestaBtn}
              </div>
              <div style="width: 120px; min-width: 120px; max-width: 120px; text-align:center; color:${estadoColor}; padding: 0.5rem 0.25rem; word-wrap: break-word;">${estadoBadge}</div>
            </div>
          `;
          return { html: eventHtml };
        }
        let eventNode = document.createElement('div');
        eventNode.innerHTML = `<b>${arg.timeText}</b> ${arg.event.title}`;
        eventNode.style.backgroundColor = arg.event.backgroundColor;
        eventNode.style.borderColor = arg.event.borderColor;
        eventNode.style.color = '#000';
        eventNode.classList.add('fc-event-main');

        return { domNodes: [eventNode] };
      },
      datesSet: function(info) {
        setTimeout(function() {
          // Eliminar encabezados previos
          document.querySelectorAll('.fc-encabezado-tareas').forEach(e => e.remove());
          // Buscar el contenedor de la lista diaria
          let dayHeader = document.querySelector('.fc-list-day > .fc-list-day-cushion');
          if (dayHeader) {
            let encabezado = document.createElement('div');
            encabezado.className = 'fc-encabezado-tareas d-flex align-items-center w-100 fw-bold mb-2';
            encabezado.innerHTML = `
              <div style="width: 140px; min-width: 140px; max-width: 140px; text-align:center; padding: 0.5rem 0.25rem; word-wrap: break-word;">Comercial</div>
              <div style="width: 180px; min-width: 180px; max-width: 180px; text-align:center; padding: 0.5rem 0.25rem; word-wrap: break-word;">Cliente</div>
              <div class="flex-grow-1" style="min-width: 200px; text-align:center; padding: 0.5rem 0.25rem; word-wrap: break-word;">Tarea</div>
              <div style="width: 120px; min-width: 120px; max-width: 120px; text-align:center; padding: 0.5rem 0.25rem; word-wrap: break-word;">Acciones</div>
              <div style="width: 120px; min-width: 120px; max-width: 120px; text-align:center; padding: 0.5rem 0.25rem; word-wrap: break-word;">Estado</div>
            `;
            // Insertar despu√©s del t√≠tulo de la fecha
            dayHeader.parentNode.insertBefore(encabezado, dayHeader.nextSibling);
          }
        }, 0);
      }
    });
    calendar.render();
    
    // Test para verificar que los botones de encuesta existen
    setTimeout(() => {
      const encuestaBtns = document.querySelectorAll('.encuesta-btn');
      console.log('Botones de encuesta encontrados:', encuestaBtns.length);
      encuestaBtns.forEach((btn, index) => {
        console.log(`Bot√≥n ${index}:`, btn.getAttribute('data-cliente-id'), btn.getAttribute('data-telefono'));
      });
    }, 2000);

    document.getElementById('toggle-resueltas').addEventListener('click', function() {
      mostrarResueltas = !mostrarResueltas;
      this.textContent = mostrarResueltas ? 'Ocultar resueltas' : 'Ver resueltas';
      calendar.refetchEvents();
    });

    {% if es_admin %}
    document.getElementById('filtro-comercial').addEventListener('change', function() {
      calendar.refetchEvents();
    });
    {% endif %}

    if (window.innerWidth <= 700) {
      document.querySelector('.botones-superiores').style.display = 'none';
      // Control de navegaci√≥n de d√≠as
      document.getElementById('btn-dia-anterior').onclick = function() { calendar.prev(); };
      document.getElementById('btn-dia-siguiente').onclick = function() { calendar.next(); };
      document.getElementById('btn-hoy').onclick = function() { calendar.today(); };
    } else {
      document.querySelector('.barra-navegacion-movil').style.display = 'none';
    }

  });
</script>

<style>
/* Ocultar la columna de horas en la vista semanal */
.fc-timegrid-axis, .fc-timegrid-axis-frame { display: none !important; }
.fc .fc-timegrid-slot-label { display: none !important; }
.fc .fc-timegrid-col-frame { border-left: 1px solid #eee; }

/* Ocultar el encabezado azul de la fecha en la vista diaria */
.fc-list-day-cushion { display: none !important; }

/* Sombreado para s√°bados y domingos en la vista de semana y mes */
.fc-day-sat, .fc-day-sun {
    background-color: #f8f9fa !important;
}



  @media (max-width: 768px) {
    .card.shadow.p-4.flex-grow-1 {
      padding: 2rem 0.1rem !important;
      border-radius: 0 !important;
      box-shadow: none !important;
    }
    #calendar, .fc {
      font-size: 1.7rem !important;
    }
    .fc-toolbar-title {
      font-size: 2.1rem !important;
    }
    .btn, .btn-sm, .btn-primary, .btn-outline-secondary, .btn-outline-primary {
      font-size: 1.7rem !important;
      padding: 1.5rem 1.1rem !important;
    }
    .form-select, .form-select-sm {
      font-size: 1.7rem !important;
      padding: 1.2rem 1.1rem !important;
    }
    .fc-list-day-cushion, .fc-list-event-title, .fc-list-event-time {
      font-size: 1.7rem !important;
    }
    .fc .fc-list-event {
      min-height: 64px !important;
    }
    
    /* En m√≥vil, permitir que las columnas se ajusten */
    .fc-list-day .d-flex > div {
      width: auto !important;
      min-width: auto !important;
      max-width: none !important;
      flex-shrink: 1 !important;
    }
  }
</style>
{% endblock %} 